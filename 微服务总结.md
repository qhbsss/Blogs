# 服务拆分

## 纵向拆分

从业务维度进⾏拆分。标准是按照业务的关联程度来决定，关联⽐较密切的业务适合拆分为⼀个微服务，⽽功能相对⽐较独⽴的业务适合单独拆分为⼀个微服务。

将不同的功能模块服务化，独⽴部署和运维。以社交App为例，你可以认为⾸⻚信息流是⼀个服务，评论是⼀个服务，消息通知是⼀个服务，个⼈主⻚也是⼀个服务。

## 横向拆分

从公共且独⽴功能维度拆分。标准是按照是否有公共的被多个其他服务调⽤，且依赖的资源独⽴不与其他业务耦合。

以社交App举例，⽆论是⾸⻚信息流、评论、消息箱还是个⼈主⻚，都需要显示⽤户的昵称。假如⽤户的昵称功能有产品需求的变更，你需要上线⼏乎所有的服务，这个成本就有点⾼了。显⽽易⻅，如果我把⽤户的昵称功能单独部署成⼀个独⽴的服务，那么有什么变更我只需要上线这个服务即可，其他服务不受影响，开发和上线成本就⼤⼤降低了。

# 服务化需要解决的问题

## 1. 服务如何定义
对于单体应⽤来说，不同功能模块之前相互交互时，通常是以类库的⽅式来提供各个模块的功能。对于微服务来说，每个服务都运⾏在各⾃的进程之中，应该以何种形式向外界传达⾃⼰的信息呢？答案就是接⼝，⽆论采⽤哪种通讯协议，是HTTP还是RPC，服务之间的调⽤都通过接⼝描述来约定，约定内容包括接⼝名、接⼝参数以及接⼝返回值。
## 2. 服务如何发布和订阅
单体应⽤由于部署在同⼀个WAR包⾥，接⼝之间的调⽤属于进程内的调⽤。⽽拆分为微服务独⽴部署后，服务提供者该如何对外暴露⾃⼰的地址，服务调⽤者该如何查询所需要调⽤的服务的地呢？这个时候你就需要⼀个类似登记处的地⽅，能够记录每个服务提供者的地址以供服务调⽤者查询，在微服务架构⾥，这个地⽅就是注册中⼼。
## 3. 服务如何监控
通常对于⼀个服务，我们最关⼼的是QPS（调⽤量）、AvgTime（平均耗时）以及P999（99.9%的请求性能在多少毫秒以内）这些指标。这时候你就需要⼀种通⽤的监控⽅案，能够覆盖业务埋点、数据收集、数据处理，最后到数据展示的全链路功能。
## 4. 服务如何治理
可以想象，拆分为微服务架构后，服务的数量变多了，依赖关系也变复杂了。⽐如⼀个服务的性能有问题时，依赖的服务都势必会受到影响。可以设定⼀个调⽤性能阈值，如果⼀段时间内⼀直超过这个值，那么依赖服务的调⽤可以直接返回，这就是熔断，也是服务治理最常⽤的⼿段之⼀。
## 5. 故障如何定位
在单体应⽤拆分为微服务之后，⼀次⽤户调⽤可能依赖多个服务，每个服务⼜部署在不同的节点上，如果⽤户调⽤出现问题，你需要有⼀种解决⽅案能够将⼀次⽤户请求进⾏标记，并在多个依赖的服务系统中继续传递，以便串联所有路径，从⽽进⾏故障定位。

# 微服务框架

![image-20241022180042112](https://raw.githubusercontent.com/qhbsss/Pictures/main/Blog_Picturesimage-20241022180042112.png)

## 服务描述

服务调⽤⾸先要解决的问题就是服务如何对外描述。比如，你对外提供了⼀个服务，那么这个服务的服务名叫什么？调⽤这个服务需要提供哪些信息？调⽤这个服务返回的结果是什么格式的？该如何解析？这些就是服务描述要解决的问题。
常⽤的服务描述⽅式包括RESTful API、XML配置以及IDL文件三种。

![image-20241023114203228](https://raw.githubusercontent.com/qhbsss/Pictures/main/Blog_Picturesimage-20241023114203228.png)

### RESTful API
RESTful API的⽅式，主要被⽤作HTTP或者HTTPS协议的接⼝定义，即使在⾮微服务架构体系下，也被⼴泛采⽤。

### XML配置
接下来再来给你讲下XML配置⽅式，这种⽅式的服务发布和引⽤主要分三个步骤：

- 服务提供者定义接⼝，并实现接⼝。
- 服务提供者进程启动时，通过加载server.xml配置⽂件将接⼝暴露出去。
- 服务消费者进程启动时，通过加载client.xml配置⽂件来引⼊要调⽤的接⼝。

通过在服务提供者和服务消费者之间维持⼀份对等的XML配置⽂件，来保证服务消费者按照服务提供者的约定来进⾏服务调⽤。在这种⽅式下，如果服务提供者变更了接⼝定义，不仅需要更新服务提供者加载的接⼝描述⽂件server.xml，还需要同时更新服务消费者加载的接⼝描述⽂件client.xml。

### IDL文件

IDL就是接⼝描述语⾔（interface description language）的缩写，通过⼀种中⽴的⽅式来描述接⼝，使得在不同的平台上运⾏的对象和不同语⾔编写的程序可以相互通信交流。⽐如你⽤Java语⾔实现提供的⼀个服务，也能被PHP语⾔调⽤。
也就是说IDL主要是⽤作跨语⾔平台的服务之间的调⽤，有两种最常⽤的IDL：⼀个是Facebook开源的Thrift协议，另⼀个是Google开源的gRPC协议。⽆论是Thrift协议还是gRPC协议，它们的⼯作原理都是类似的。

## 注册中心
有了服务的接口描述，下⼀步要解决的问题就是服务的发布和订阅，就是说你提供了⼀个服务，如何让外部想调⽤你的服务的人知道。这个时候就需要⼀个类似注册中心的角色，服务提供者将⾃⼰提供的服务以及地址登记到注册中心，服务消费者则从注册中心查询所需要调⽤的服务的地址，然后发起请求。

![image-20241023111220043](C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20241023111220043.png)

## 服务框架
通过注册中心，服务消费者就可以获取到服务提供者的地址，有了地址后就可以发起调⽤。但在发起调⽤之前你还需要解决以下几个问题。

- 服务通信采⽤什么协议？就是说服务提供者和服务消费者之间以什么样的协议进⾏⽹络通信，是采⽤四层TCP、UDP协
  议，还是采⽤七层HTTP协议，还是采⽤其他协议？
- 数据传输采⽤什么⽅式？就是说服务提供者和服务消费者之间的数据传输采⽤哪种⽅式，是同步还是异步，是在单连接上
  传输，还是多路复⽤。
- 数据压缩采⽤什么格式？通常数据传输都会对数据进⾏压缩，来减少⽹络传输的数据量，从⽽减少带宽消耗和⽹络传输时
  间，⽐如常⻅的JSON序列化、Java对象序列化以及Protobuf序列化等。

## 服务监控
⼀旦服务消费者与服务提供者之间能够正常发起服务调⽤，你就需要对调⽤情况进⾏监控，以了解服务是否正常。通常来讲，服务监控主要包括三个流程。

- 指标收集。就是要把每⼀次服务调⽤的请求耗时以及成功与否收集起来，并上传到集中的数据处理中⼼。
- 数据处理。有了每次调⽤的请求耗时以及成功与否等信息，就可以计算每秒服务请求量、平均耗时以及成功率等指标。
- 数据展示。数据收集起来，经过处理之后，还需要以友好的⽅式对外展示，才能发挥价值。通常都是将数据展示在
  Dashboard⾯板上，并且每隔10s等间隔⾃动刷新，⽤作业务监控和报警等。

## 服务追踪
除了需要对服务调⽤情况进⾏监控之外，你还需要记录服务调⽤经过的每⼀层链路，以便进⾏问题追踪和故障定位。
服务追踪的⼯作原理⼤致如下：

- 服务消费者发起调⽤前，会在本地按照⼀定的规则⽣成⼀个requestid，发起调⽤时，将requestid当作请求参数的⼀部分，
  传递给服务提供者。
- 服务提供者接收到请求后，记录下这次请求的requestid，然后处理请求。如果服务提供者继续请求其他服务，会在本地再
  ⽣成⼀个⾃⼰的requestid，然后把这两个requestid都当作请求参数继续往下传递。

## 服务治理
服务监控能够发现问题，服务追踪能够定位问题所在，⽽解决问题就得靠服务治理了。服务治理就是通过⼀系列的⼿段来保证
在各种意外情况下，服务调⽤仍然能够正常进⾏。在⽣产环境中，你应该经常会遇到下⾯⼏种状况。

- 单机故障。通常遇到单机故障，都是靠运维发现并重启服务或者从线上摘除故障节点。然⽽集群的规模越⼤，越是容易遇
  到单机故障，在机器规模超过⼀百台以上时，靠传统的⼈⾁运维显然难以应对。⽽服务治理可以通过⼀定的策略，⾃动摘
  除故障节点，不需要⼈为⼲预，就能保证单机故障不会影响业务。
- 单IDC故障。你应该经常听说某某App，因为施⼯挖断光缆导致⼤批量⽤户⽆法使⽤的严重故障。⽽服务治理可以通过⾃动
  切换故障IDC的流量到其他正常IDC，可以避免因为单IDC故障引起的⼤批量业务受影响。
- 依赖服务不可⽤。⽐如你的服务依赖依赖了另⼀个服务，当另⼀个服务出现问题时，会拖慢甚⾄拖垮你的服务。⽽服务治
  理可以通过熔断，在依赖服务异常的情况下，⼀段时期内停⽌发起调⽤⽽直接返回。这样⼀⽅⾯保证了服务消费者能够不
  被拖垮，另⼀⽅⾯也给服务提供者减少压⼒，使其能够尽快恢复。